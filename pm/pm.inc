;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
;				存储段描述符						
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
;	  ______________________________________________________________________________________________________________________________________________________________
;	 |                   |                   |                   |                                                           |					|
;	 |  段基址2(24---31) |    段属性           |        段属性      |                      段基址1（0---23）                      |          段界限1（0---15）		|
;	 |___________________|___________________|___________________|___________________________________________________________|______________________________________|
;                                      /                   \
;                                     /                     \
;                                    /                       \
;                                   /                         \
;                                  /                           \
;                                 /              |              \
;         _______________________/_______________|_______________\_______________________
;        |    |    |    |    |                   |    |         |    |                   |
;        | G  | D/B| 0  | AVL| 段界限2（16---19）| P  |   DPL   |  S |         TYPE      |
;        |____|____|____|____|___________________|____|_________|____|___________________|
;                                                |
;                                                |
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;;	描述符的宏
;;	usage: 段基址， 段界限， 段属性
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
%macro	Descriptor 3
	dw	%2 & 0FFFFh				;
	dw	%1 & 0FFFFh				;
	db	(%1 >> 16) & 0FFh			;
	dw	(%3 & 0F0FFh) | ((%2 >> 8) & 0F00h)	;
	db	(%1 >> 24) & 0FFh			;
%endmacro


;%macro	Descriptor 3
;	dw	%2 & 0FFFFh				;段界限1，共16字节
;	dw	%1 & 0FFFFh				;段基址1
;	db	(%1 >> 16) & 0FFh			;段基址2
;	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	;属性及段界限2
;	db	(%1 >> 24) && 0FFh			;段基址3
;%endmacro

;%macro Descriptor 3
;	dw	%2 & 0FFFFh				; 段界限1
;	dw	%1 & 0FFFFh				; 段基址1
;	db	(%1 >> 16) & 0FFh			; 段基址2
;	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	; 属性1 + 段界限2 + 属性2
;	db	(%1 >> 24) & 0FFh			; 段基址3
;%endmacro ; 共 8 字节
;
;G位：段界限粒度位。
;D/B位：分3种情况。1）在可执行代码段描述符中为D位，D=1时，默认使用32位地址及32位或8位操作数；2)向下扩展的的数据段中为B位，B=1时，段界限为4G，反之则为64K; 3）堆栈段中
;                     位B位，B=1时，隐式的堆栈访问指令如push、pop等使用32位堆栈指针寄存器esp，反之则使用16位的堆栈指针寄存器sp。
;AVL位：保留位。
;P位：存在位。
;DPL位：描述符特权级
;S位：S=1，数据段或代码段；S=0，系统段或门描述符。
;TYPE描述符类型：
;________________________________________________________________________________________
;   TYPE值   |	数据段和代码段描述符	    |	系统段和门描述符
;------------|------------------------------|--------------------------------------------
;     0      |  只读                        |   <未定义>
;------------|------------------------------|--------------------------------------------
;     1      |  只读，已访问                  |	可用286TSS
;------------|------------------------------|--------------------------------------------
;     2      |  读/写                        |    LDT
;------------|------------------------------|--------------------------------------------
;     3      |  读/写，已访问               |	忙的286TSS
;------------|------------------------------|--------------------------------------------
;     4      |  向下扩展，只读              |	286调用门
;------------|------------------------------|--------------------------------------------
;     5      |  向下扩展，只读，已访问      |   任务门
;------------|------------------------------|--------------------------------------------
;     6      |  向下扩展，读/写             |   286中断门
;------------|------------------------------|--------------------------------------------
;     7      |  向下扩展，读/写，已访问     |   286陷阱门
;------------|------------------------------|--------------------------------------------
;     8      |  只执行                      |   <未定义>
;------------|------------------------------|--------------------------------------------
;     9      |  只执行，已访问              |   可用386TSS
;------------|------------------------------|--------------------------------------------
;     A      |  执行/读                     |   <未定义>
;------------|------------------------------|--------------------------------------------
;     B      |  执行/读，已访问             |   忙的386TSS
;------------|------------------------------|--------------------------------------------
;     C      |  一致代码段，只执行          |   386调用门
;------------|------------------------------|--------------------------------------------
;     D      |  一致代码段，只执行，已访问  |   <未定义>
;------------|------------------------------|--------------------------------------------
;     E      |  一致代码段，执行/读         |   386中断门
;------------|------------------------------|--------------------------------------------
;     F      |  一致代码段，执行/读，已访问 |   386陷阱门
;------------|------------------------------|--------------------------------------------
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;				
;;	描述符类型
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
DA_32			equ	04000h		; D/B位为1，32位段
DA_LIMIT_4K		equ	08000h		; G位，段界限的粒度为4K

DA_DPL0		equ	00h		; 
DA_DPL1		equ	20h		;
DA_DPL2		equ	40h		;
DA_DPL3		equ	60h		;

;存储段描述符类型,默认P=1且S=1，即存在的数据或代码段
DA_DR		equ	90h		;只读数据段
DA_DRW		equ	92h		;可读写数据段
DA_DRWA	equ	93h		;可读写已访问的数据段
DA_C		equ	98h		;折执行代码段
DA_CR		equ	9Ah		;可执行/读代码段
DA_CCO		equ	9Ch		;可执行一致代码段
DA_CCOR	equ	9Eh		;可执行/读一致代码段

;系统段描述符类型,默认P=1且S=0，即存在的系统段或门
DA_LDT		equ	82h		;
DA_TaskGate	equ	85h		;
DA_386TSS	equ	89h		;
DA_386CGate	equ	8Ch		;
DA_386IGate	equ	8Eh		;
DA_386TGate	equ	8Fh		;

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;	选择子属性
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
SA_RPL0		equ	00h		;
SA_RPL1		equ	01h
SA_RPL2		equ	02h
SA_RPL3		equ	03h

SA_TIG		equ	00h
SA_TIL		equ	04h


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
;				门描述符: 选择子，偏移，参数个数，属性						
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;  
;	 |       BYTE7       |       BYTE6       |       BYTE5       |       BYTE4       |       BYTE3       |      BYTE2        |      BYTE1        |       BYTE0       |
;	 | __________________|___________________|___________________|___________________|___________________|___________________|___________________|___________________|
;	 |                                       |                   |                   |                                       |					 |
;	 |            偏移2(16---31)             |        段属性     |                   |                选择子                 |               偏移1（0---15）	 |
;	 |_______________________________________|___________________|___________________|_______________________________________|_______________________________________|
;     		                                           /                   \
;		   				             /                     \
;		      				            /                       \
;		                                        /                         \
;		                                       /                           \ 
;		                                      /              |              \
;		             _______________________ /_______________|_______________\________________________
;		             |    |         |    |                   |    |     |    |                        |
;			      | P  |   DPL   |  S |        TYPE       | 0  |  0  |  0 |       Param Count      |
;		             |____|_________|____|___________________|____|_____|____|________________________|
;		                                                     |
;		                                                     |
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;;	门描述符的宏
;;	usage:  选择子，偏移，参数个数，门属性
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
%macro	Gate 4
	dw	%2 & 0FFFFh				;
	dw	%1 & 0FFFFh				;
	db	%3 & 1Fh				;
	db	%4 & 0FFh				;
	dw	(%2 >> 16) & 0FFFFh			;
%endmacro

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
;页表及页目录属性定义
;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
PG_P		equ	01h				;页表或页目录存在
PG_RWR		equ	00h				;R/W 属性位值, 读/执行
PG_RWW		equ 	02h				;R/W 属性位值, 读/写/执行
PG_USU		equ	04h				;U/S 属性位值, 用户级
PG_USS		equ	00h				;U/S 属性位值, 系统级